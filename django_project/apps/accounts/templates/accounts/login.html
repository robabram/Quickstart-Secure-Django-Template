{% extends "__noauth_base.html" %}
{% load staticfiles %}
{% load smarturl %}
{% load i18n %}

{% block content %}

    <div id="form-title" style="color: #ccc;"><h3>Secure Django Template with REST API</h3></div>
    <div id="login-form-div">
        <form id="login-form">
        {% csrf_token %}
        <div class="container w-100 mw-100" style="background: rgba(255,255,255,0.35);">
            <div class="row">
                <div class="col-sm-12">
                    <div class="brand">&nbsp;</div>
                </div>
                <div class="col-sm-7 col-md-7 col-lg-6 login">
                    <div class="form-horizontal">

                        <div id="login-warning" style="display: none" class="form-group">
                            <div class="col-sm-3 col-md-3 control-label">
                                <label class="" name="validation"> </label>
                            </div>
                            <div class="col-sm-9 col-md-9 controls">
                                <div class="alert alert-danger">
                                    <span class="glyphicon glyphicon-alert"></span>&nbsp;&nbsp;<strong>Your username and password didn't match. Please try again.</strong>
                                </div>
                            </div>
                        </div>

                        <div class="col-sm-12 col-md-9 col-lg-7 form-group">
                            {{ form.username.label_tag }}
                            {{ form.username }}
                        </div>
                        <div class="col-sm-12 col-md-9 col-lg-7 form-group">
                            {{ form.password.label_tag }}
                            {{ form.password }}
                        </div>
                    </div>
                </div>
                <div class="col-sm-5 col-md-5 col-lg-6 login details">
                    <!--
                    <span class="glyphicon glyphicon-alert"></span>&nbsp;&nbsp;<label style="color: #333;">To login enter your user name and password, then click login.</label>
                    -->
                </div>
            </div>
            <div class="row">
                <div class="col-sm-12 col-md-offset-5 col-md-7 submit">
                    <input type="hidden" name="next" value="{{ next }}" />
                    <button id="btn-submit" class="btn btn-default btn-primary" name="login" title="{% trans 'Login' noop %}" type="submit"><i class="fa fa-lock"></i> {% trans 'Login' noop %}</button>
                </div>
            </div>
        </div>
        </form>
    </div>

{% endblock content %}

{% block script %}
<script type="application/javascript">

Cookies.remove('token');

function csrfSafeMethod(method) {
    // these HTTP methods do not require CSRF protection
    return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
}

$.ajaxSetup({
    cache: false,
    timeout: 60 * 1000,
    error: function (request, status, err) {
        //this.http_error(request, status, err)
        alert(err);
    },
    beforeSend: function (xmlhttp, settings) {
        if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
            // Send the token to same-origin, relative URLs only.
            // Send the token only if the method warrants CSRF protection
            // Using the CSRFToken value acquired earlier
            xmlhttp.setRequestHeader('X-CSRFToken', Cookies.get('csrftoken'))
        }
    }
});

$('#login-form').submit( function (e) {

    e.preventDefault();

    user = $('#{{ form.username.id_for_label }}').val();
    pass = $('#{{ form.password.id_for_label }}').val();

    $.post("/accounts/login/", {
        grant_type : "password",
        username : user,
        password : pass
    }, function( data ) {
        if (data.status == 'OK') {
            /* $('body').fadeOut(600, function () { */
                location.href = data.next;
            /* }); */

        } else
            $('#login-warning').css('display', '')
    }, "json")

});

$(document).ready(function () {
    document.getElementById("{{ form.username.id_for_label }}").focus();
});

</script>

{% endblock script %}
